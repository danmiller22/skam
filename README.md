# Lalafo Telegram Bot for Deno Deploy

Этот репозиторий содержит исходный код бота, который
автоматически собирает объявления о долгосрочной аренде квартир
на сайте **Lalafo** и отправляет их в Telegram‑канал или чат.

## Возможности

* Поддержка одного и двухкомнатных квартир (настраивается через
  переменную окружения `ROOMS`). В сообщениях количество комнат
  выводится полностью — «одна комната» или «две комнаты».
* Отправка всех объявлений без ограничения по цене. Ограничение
  можно задать с помощью `MAX_PRICE_KGS`.
* Фильтрация по собственнику: объявления от агентств
  отбрасываются, если переменная `OWNER_ONLY` равна `true`.
* Извлечение и отображение района объявления. Если район не
  найден, по умолчанию указывается «Бишкек».
* Копирование полного описания объявления, которое выводится
  внизу сообщения.
* Отправка всех фотографий (до 10) в виде медиагруппы. Если
  фотографий нет, бот отправляет текстовое сообщение.
* Хранение идентификаторов уже отправленных объявлений в Deno KV,
  чтобы не дублировать сообщения.
* Запуск по расписанию каждые пять минут с помощью cron
  (функция `Deno.cron`). Дополнительно можно вручную запустить
  сбор объявлений, обратившись к URL `/run`.

## Быстрый старт на Deno Deploy

1. **Подготовьте репозиторий**. Загрузите файлы этого проекта
   (`mod.ts`, `deno.json`, `README.md`) в репозиторий на GitHub.

2. **Создайте Telegram‑бота**. В `@BotFather` получите токен и
   создайте канал/группу, куда бот будет отправлять объявления.
   Добавьте бота администратором и разрешите ему публикацию.

3. **Деплой**. Войдите в [Deno Deploy](https://dash.deno.com) и
   создайте новый проект, указав в качестве источника ваш
   репозиторий. В настройках установите в качестве entrypoint
   `mod.ts`.

4. **Переменные окружения**. В панели проекта Deno Deploy
   добавьте переменные:

   - `TELEGRAM_BOT_TOKEN` — токен вашего бота.
   - `TELEGRAM_CHAT_ID` — идентификатор чата или канала (например,
     `-1001234567890`). Получить можно, переслав сообщение в
     `@RawDataBot` или вызвав метод `getUpdates` Telegram API.
   - (необязательно) `CITY_SLUG` — slug города на Lalafo (по
     умолчанию `bishkek`).
   - (необязательно) `MAX_PRICE_KGS` — максимальная цена в сомах.
   - (необязательно) `ROOMS` — допустимые комнаты через запятую.
     Например, `"1,2"`.
   - (необязательно) `OWNER_ONLY` — `true` (по умолчанию) —
     отправлять только объявления от собственников; `false` —
     отправлять все.
   - (необязательно) `ADS_LIMIT` — сколько объявлений
     максимум отправлять за один проход (по умолчанию 50).
   - (необязательно) `PAGES` — количество страниц для скрейпа
     (по умолчанию 10).

5. **Запустите**. После деплоя бот будет автоматически
   выполнять скрейп каждые 5 минут и отправлять новые
   объявления в Telegram. Для проверки вы можете открыть URL
   вида `https://<ваш-проект>.deno.dev/run` — это запустит сбор
   объявлений принудительно.

## Локальный запуск

Для локальной отладки убедитесь, что установлена Deno версии
не ниже 1.34:

```sh
deno task dev
```

Не забудьте создать файл `.env` или установить необходимые
переменные окружения (`TELEGRAM_BOT_TOKEN`, `TELEGRAM_CHAT_ID`,
`CITY_SLUG` и т. д.). Локально сообщения будут отправляться
точно так же, как и в Deploy, при условии доступа в
интернет.